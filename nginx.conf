events {events {

    worker_connections 1024;    worker_connections 1024;

}}



http {http {

    # Rate limiting    upstream webstar_backend {

    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;        server webstar-server:5090;

    }

    server {

        listen 80;    # Rate limiting

        server_name _;    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;



        # Proxy all requests to the WebStar container    server {

        location / {        listen 80;

            proxy_pass http://localhost:5090;        server_name _;

            proxy_set_header Host $host;

            proxy_set_header X-Real-IP $remote_addr;        # Let's Encrypt challenge

            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        location /.well-known/acme-challenge/ {

            proxy_set_header X-Forwarded-Proto $scheme;            root /var/www/html;

                    }

            # WebSocket support (if needed for WebRTC)

            proxy_http_version 1.1;        # Redirect all other HTTP traffic to HTTPS

            proxy_set_header Upgrade $http_upgrade;        location / {

            proxy_set_header Connection "upgrade";            return 301 https://$server_name$request_uri;

                    }

            # Timeouts    }

            proxy_connect_timeout 60s;

            proxy_send_timeout 60s;    server {

            proxy_read_timeout 60s;        listen 443 ssl http2;

        }        server_name _;



        # Rate limiting for API endpoints        # SSL configuration with Let's Encrypt certificates

        location /api/ {        ssl_certificate /etc/letsencrypt/live/dev.webstar.santaslair.net/fullchain.pem;

            limit_req zone=api burst=20 nodelay;        ssl_certificate_key /etc/letsencrypt/live/dev.webstar.santaslair.net/privkey.pem;

            proxy_pass http://localhost:5090;        ssl_trusted_certificate /etc/letsencrypt/live/dev.webstar.santaslair.net/chain.pem;

            proxy_set_header Host $host;        

            proxy_set_header X-Real-IP $remote_addr;        # SSL security settings

            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        ssl_protocols TLSv1.2 TLSv1.3;

            proxy_set_header X-Forwarded-Proto $scheme;        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;

        }        ssl_prefer_server_ciphers off;

        ssl_session_timeout 10m;

        # Health check endpoint        ssl_session_cache shared:SSL:10m;

        location /health {        ssl_session_tickets off;

            proxy_pass http://localhost:5090/health;        ssl_stapling on;

            proxy_set_header Host $host;        ssl_stapling_verify on;

        }

        # Security headers

        # WebSocket endpoint        add_header Strict-Transport-Security "max-age=63072000" always;

        location /ws {        add_header X-Frame-Options DENY always;

            proxy_pass http://localhost:5090;        add_header X-Content-Type-Options nosniff always;

            proxy_http_version 1.1;

            proxy_set_header Upgrade $http_upgrade;        # Rate limiting

            proxy_set_header Connection "upgrade";        limit_req zone=api burst=20 nodelay;

            proxy_set_header Host $host;

            proxy_set_header X-Real-IP $remote_addr;        # Health check endpoint

            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        location /health {

            proxy_set_header X-Forwarded-Proto $scheme;            proxy_pass http://webstar_backend;

                        proxy_set_header Host $host;

            # WebSocket specific timeouts            proxy_set_header X-Real-IP $remote_addr;

            proxy_read_timeout 86400;            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_send_timeout 86400;            proxy_set_header X-Forwarded-Proto https;

            proxy_connect_timeout 60s;        }

        }

    }        # WebSocket support with SSL

}        location /ws {
            proxy_pass http://webstar_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            
            # WebSocket specific timeouts
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
            proxy_connect_timeout 60s;
        }

        # API endpoints
        location / {
            proxy_pass http://webstar_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }
    }
}
